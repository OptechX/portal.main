name: Build Node Image

on:
  workflow_dispatch:
  schedule:
    - cron: '1 4 * * 2,4,6'

env:
  DOCKER_NODE_VERSION: "1.0"
  DOCKER_NODE_IMAGE: "repasscloud/optechx.portal.node"

jobs:
  node-build:
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v3

      - name: 🔐 Decrypt Repo
        run: ./decrypt_repo.sh
        env:
          LARGE_SECRET_PASSPHRASE: ${{ secrets.LARGE_SECRET_PHRASE }}
        shell: bash

      - name: 🐳🏗️ Docker .node Build
        run: |
          docker build --rm --no-cache --tag "$DOCKER_NODE_IMAGE:$DOCKER_NODE_VERSION" --file Dockerfile.node .
          docker tag "$DOCKER_NODE_IMAGE:$DOCKER_NODE_VERSION" "$DOCKER_NODE_IMAGE"

      - name: 🚀🐳 Publish .node to Docker Hub
        run: |
          echo "Build number: ${{ steps.buildnumber.outputs.build_number }}"
          docker image push "$DOCKER_NODE_IMAGE:$DOCKER_NODE_VERSION"
          docker image push "$DOCKER_NODE_IMAGE"